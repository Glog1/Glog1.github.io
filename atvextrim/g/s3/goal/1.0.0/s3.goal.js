!function(e){function t(o){if(n[o])return n[o].exports;var r=n[o]={exports:{},id:o,loaded:!1};return e[o].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";var o=n(2),r=window.s3=window.s3||{};r.Ecommerce=o.Ecommerce,r.Goal=o.Goal},function(e,t){"use strict";function n(e,t){if(Array.isArray(e)||e instanceof NodeList)[].forEach.call(e,t);else if("object"===("undefined"==typeof e?"undefined":o(e)))for(var n in e)e.hasOwnProperty(n)&&t(e[n],n)}Object.defineProperty(t,"__esModule",{value:!0});var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};t.default=n},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.Ecommerce=t.Goal=void 0;var u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),c=n(10),i=o(c),f=n(4),l=o(f),d=n(1),s=o(d),v=n(5),y=o(v),m=n(9),p=o(m),_=n(8),h=o(_),g=n(3),b=o(g),k=n(7),O=o(k),E=t.Goal=function(){function e(t){r(this,e),e.map=t.map||{},e.ecommerce=t.ecommerce||[],w.init(e.ecommerce),e.bindEvents(),e.observe(function(t){if("IFRAME"===t.tagName){try{var n=t.contentWindow;n&&n.addEventListener&&n.addEventListener("DOMContentLoaded",function(){n.s3&&n.s3.Goal||e.bindEvents(n.document)})}catch(t) {return;}}})}return a(e,null,[{key:"bindEvents",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document,n=(0,O.default)(e.map,"event");(0,s.default)(n,function(n){t.addEventListener(n,function(t){e.handle(t.target,n)},!0)})}},{key:"handle",value:function(t,n){if("FORM"===t.tagName){var o=t.getAttribute(e.GOAL_ANKETA_ID_ATTR);if(!o){var r=(0,l.default)(t,"["+e.GOAL_API_FORM_URL_ATTR+"]");r&&(o=e.getApiFormId(r))}if(!o)return;return void(0,s.default)(e.map,function(t){t.object_id!=o||t.event!=n||"anketa"!=t.code&&"anketa2"!=t.code||(t.object="form",e.send(t))})}}},{key:"send",value:function(t){switch(t.system){case"analytics":e.googleSend(t);break;case"metrika":e.yandexSend(t)}}},{key:"googleSend",value:function(t){var n=e.googleCounters;return(0,s.default)(n,function(n){n(function(){var e=n.getAll();e.forEach(function(e){var o=e.get("name");n(o+".send","event",t.object,t.event,t.label)})}),e.logEnabled&&console.info("Goal.send",t)}),!0}},{key:"yandexSend",value:function(t){var n=e.yandexCounters;return!!n&&((0,s.default)(n,function(n){n.reachGoal(t.label,{object:t.object,event:t.event}),e.logEnabled&&console.info("Goal.send",t)}),!0)}},{key:"observe",value:function(e){if(window.MutationObserver){var t=new MutationObserver(function(t){t.forEach(function(t){[].forEach.call(t.addedNodes,function(t){t.nodeType==Node.ELEMENT_NODE&&e(t)})})});t.observe(document,{childList:!0,subtree:!0})}}},{key:"getApiFormId",value:function(t){var n=t.getAttribute(e.GOAL_API_FORM_URL_ATTR);if(!n)return null;var o=n.match(/(?:&|\?)param\[form_id\]=(\d+)(?:&|$)/);return o&&2===o.length?o[1]:null}},{key:"googleCounters",get:function(){return window.ga?[window.ga]:[]}},{key:"yandexCounters",get:function(){try{return(0,p.default)(Ya._metrika.counters)}catch(t){return e.logEnabled&&console.error(t),[]}}},{key:"googleDataLayerKeys",get:function(){if(!window.google_tag_manager)return[];var e=(0,y.default)(google_tag_manager,function(e){return e.gtmDom&&e.gtmLoad});return e?[e]:[]}},{key:"yandexDataLayerKeys",get:function(){var t=e.yandexCounters,n=[];return(0,s.default)(t,function(e){e._ecommerce&&n.push(e._ecommerce)}),n}}]),e}();E.GOAL_ANKETA_ID_ATTR="data-s3-anketa-id",E.GOAL_API_FORM_URL_ATTR="data-api-url",E.logEnabled=!1;var w=t.Ecommerce=function(){function e(){r(this,e)}return a(e,null,[{key:"init",value:function(t){t.forEach(function(t){var n=null;try{n=t.ecommerce.purchase.actionField.id}catch(e){}if(n){e.state.delete("products");var o=e.state.get("orders")||{};if(o[n])return;o[n]=1,e.state.set("orders",o)}return t._correction?void e.recount(t._correction):void e.push(t)}),setInterval(function(){e.send()},100),window.jQuery&&jQuery.ajaxSetup({beforeSend:function(t,n){var o=n.url.match(/(?:\?|&)cmd=(cartAddItem|cartRemoveItem|cartUpdate)(?:&|$)/);if(o&&2===o.length){var r=o[1];switch(r){case"cartAddItem":t.done(function(t){"object"==("undefined"==typeof t?"undefined":u(t))&&t.ecommerce&&e.addProduct(t.ecommerce)})}}}})}},{key:"push",value:function(t){["add","remove","detail","purchase"].some(function(e){if(t.ecommerce[e])return t.event="s3_shop_"+e,!0}),e._pool.push({value:t,layers:{}}),e.send()}},{key:"send",value:function(){var t=(0,h.default)(E.googleDataLayerKeys.concat(E.yandexDataLayerKeys));(0,s.default)(t,function(t){var n=window[t]=window[t]||[];(0,s.default)(e._pool,function(o){if(!o.layers[t]){var r=(0,b.default)(o.value);n.push(r),e.logEnabled&&console.info("Ecommerce.send",t,r),o.layers[t]=!0}})})}},{key:"addProduct",value:function(t){var n=e.state.get("products")||{};t.forEach(function(t){t.ecommerce.add.products.forEach(function(t){var o=e.getKeyProduct(t);return n[o]?void(n[o].quantity+=t.quantity):void(n[o]=t)}),e.push(t)}),e.state.set("products",n)}},{key:"getKeyProduct",value:function(e){return JSON.stringify([e.id+"",e.variant])}},{key:"recount",value:function(t){var n={};(0,s.default)(t,function(t){n[e.getKeyProduct(t)]=t});var o=e.state.get("products")||{};(0,s.default)(n,function(t,r){if(!o[r])return o[r]=t,void e.add(t);var u=n[r].quantity-o[r].quantity;u<0?(t.quantity=-u,e.remove(t),o[r].quantity+=u):u>0&&(t.quantity=u,e.add(t),o[r].quantity+=u)}),(0,s.default)(o,function(t,r){n[r]||(e.remove(t),delete o[r])}),e.state.set("products",o)}},{key:"remove",value:function(t){e.push({ecommerce:{remove:{products:[t]}}})}},{key:"add",value:function(t,n){e.push({ecommerce:{add:{products:[t]}}})}}]),e}();w.state=new i.default("s3.goal.ecommerce"),w._pool=[],w.logEnabled=!1},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return JSON.parse(JSON.stringify(e))}},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){for(;e;){if((0,u.default)(e,t))return e;e=e.parentElement}return null};var r=n(6),u=o(r)},function(e,t){"use strict";function n(e,t){for(var n in e){if(!e.hasOwnProperty(n))return;if(t(e[n]))return n}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=n},function(e,t){"use strict";function n(e,t){return!!o&&e[o](t)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=n;var o=t.matchesMethodName=function(){for(var e=["matches","matchesSelector","webkitMatchesSelector","mozMatchesSelector","msMatchesSelector","oMatchesSelector"],t=0,n=e.length;t<n;t++)if(Element.prototype[e[t]])return e[t];return!1}()},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){var n={};return(0,u.default)(e,function(e){var o=e[t];o&&(n[o]=1)}),Object.keys(n)};var r=n(1),u=o(r)},function(e,t){"use strict";function n(e){var t=[];return e.forEach(function(e){t.indexOf(e)===-1&&t.push(e)}),t}Object.defineProperty(t,"__esModule",{value:!0}),t.default=n},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}function r(e){var t=[];return(0,a.default)(e,function(e){t.push(e)}),t}Object.defineProperty(t,"__esModule",{value:!0}),t.default=r;var u=n(1),a=o(u)},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},r=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),u=function(){function e(t){var o=arguments.length<=1||void 0===arguments[1]?"local":arguments[1];n(this,e),this._key=t,this._storage=window[o+"Storage"];var r=this._storage.getItem(t);this._value=r?JSON.parse(r):{}}return r(e,[{key:"_save",value:function(){this._storage.setItem(this._key,JSON.stringify(this._value))}},{key:"clear",value:function(){return this._value={},this._save(),this}},{key:"get",value:function(e){return this._value[e]}},{key:"set",value:function(e,t){return this._value[e]=t,this._save(),this}},{key:"delete",value:function(e){return delete this._value[e],this._save(),this}},{key:"value",get:function(){return o({},this._value)}},{key:"isEmpty",get:function(){return 0===Object.keys(this._value).length}}]),e}();t.default=u}]);
//# sourceMappingURL=s3.goal.js.map